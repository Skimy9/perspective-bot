# utils/nagual_journey.py
import datetime
import logging
from typing import Dict, List, Optional
logger = logging.getLogger(__name__)

# Структура этапа (обновленная)
Stage = {
    "title": str,
    "description": str,
    "options": List[str],
    "correct_option": int,
    "wrong_messages": List[str],  # Теперь список сообщений для каждого неправильного ответа
    "correct_message": str,
    "next_stage_delay": int  # в минутах
}

# Все этапы пути (обновленные)
STAGES = [
    {
        "title": "Первая Трещина",
        "description": ("Вы стоите на пустынной улице в полдень. Воздух дрожит, как поверхность воды. "
                       "Перед вами пятиэтажка, но сегодня она кажется... ненастоящей. Вы замечаете <i>трещину</i> "
                       "в реальности — тонкую линию, где кирпичные стены теряют четкость.\n\n"
                       "Это не галлюцинация. Это приглашение. Что-то в глубине вас узнает этот знак. "
                       "Вы чувствуете, как ваше сознание слегка смещается, как если бы вы стояли на краю пропасти, "
                       "но не боялись упасть. Воздух становится плотнее, звуки искажаются, как в воде."),
        "options": [
            "Сфотографировать \"для доказательств\"",
            "Прикоснуться к трещине",
            "Позвонить другу, чтобы подтвердить",
            "Игнорировать трещину",
            "Попытаться заполнить трещину"
        ],
        "correct_option": 1,
        "wrong_messages": [
            ("Вы достаете телефон, но экран искажается, как будто вы смотрите на него через толстое стекло. "
             "Когда вы пытаетесь сделать фото, камера показывает пустую улицу без трещины. Вы начинаете сомневаться в своем зрении."),
            
            ("Вы набираете номер друга, но вместо голоса слышите странное эхо собственных слов. "
             "Разговор становится бессмысленным, как будто вы говорите на языке, который больше не существует. "
             "Вы кладете трубку, чувствуя, что только что потеряли связь с реальностью."),
            
            ("Вы проходите мимо, стараясь не смотреть на трещину. Но теперь вы замечаете их повсюду — "
             "в асфальте, в окнах зданий, даже в собственных мыслях. То, что вы игнорировали, "
             "начинает преследовать вас, как навязчивая мысль."),
            
            ("Вы пытаетесь заткнуть трещину бумагой, но она проваливается внутрь, словно в бездонную пропасть. "
             "Вы чувствуете, как земля под ногами становится непрочной, как будто сама реальность "
             "может в любой момент распасться на части.")
        ],
        "correct_message": ("Ваши пальцы проходят сквозь кирпичную стену, как сквозь воду. "
                           "Вы оказываетесь в комнате без окон, где на полу пульсирует символ, "
                           "который вы <i>уже видели</i> во сне. Вы чувствуете, как ваше \"я\" становится жидким. "
                           "Слово \"я\" теряет смысл. Вы не спрашиваете, где вы — вы чувствуете."),
        "next_stage_delay": 0
    },
    {
        "title": "Комната Без Окон",
        "description": ("Вы стоите в комнате без окон. Символ на полу пульсирует, как сердце. "
                       "Воздух здесь плотный, как вода, и каждый звук растягивается во времени. "
                       "Вы чувствуете, как ваше \"я\" становится жидким.\n\n"
                       "Слово \"я\" теряет смысл. Вы не спрашиваете, где вы — вы чувствуете, "
                       "что вопрос сам по себе — ловушка. Что-то в глубине вас наблюдает за вами. "
                       "Вы чувствуете его присутствие как давление на кожу, как мурашки по спине."),
        "options": [
            "Позволить себе растечься",
            "Сосредоточиться на имени",
            "Искать выход из комнаты",
            "Закричать",
            "Попытаться нарисовать карту"
        ],
        "correct_option": 0,
        "wrong_messages": [
            "Вы хватаетесь за свое имя, как за спасательный круг... и момент упущен. Точка сборки возвращается на место, но вы чувствуете, что что-то безвозвратно потеряно. Вы провалитесь в обычную реальность, но часть вас будет помнить этот момент.",
            
            "Вы пытаетесь найти выход... и стены начинают двигаться. Вы понимаете: комната — это ваш разум. Вы застрянете здесь, пока не поймете: \"Почему я верю, что должен выйти?\"",
            
            "Вы кричите... и звук возвращается эхом, становясь все громче. Вы оказываетесь в ловушке своего собственного страха, пока не научитесь молчать.",
            
            "Вы пытаетесь нарисовать карту... и чернила превращаются в трещины. Вы видите, что карта — это тоже иллюзия. Вы застрянете в попытках понять непонятное."
        ],
        "correct_message": ("Вы перестаете бороться. Точка сборки смещается, и вы видите мир <i>иначе</i>. "
                           "Стены комнаты становятся прозрачными, и вы видите, что находитесь "
                           "в центре огромного энергетического вихря. Голос говорит: "
                           "\"Теперь ты видишь сквозь завесу. Но видеть — не значит понимать.\""),
        "next_stage_delay": 0
    },
    {
        "title": "Стена Огня",
        "description": ("Вы стоите перед стеной огня. Она не горячая, а... <i>липкая</i>. "
                       "За ней — тень, которая знает ваше имя. Огонь не светит — он <i>поглощает</i> свет, "
                       "создавая зону абсолютной тишины.\n\n"
                       "Голос из предыдущей комнаты шепчет: \"Стена огня разделяет тех, кто видит, "
                       "и тех, кто знает.\" Вы понимаете, что это не метафора. Это проверка. "
                       "Огонь не обжигает — он <i>пропускает</i> вас, как луч света через воду."),
        "options": [
            "Искать обходной путь",
            "Пройти сквозь огонь",
            "Крикнуть тени",
            "Попытаться потушить огонь",
            "Задать вопрос огню"
        ],
        "correct_option": 1,
        "wrong_messages": [
            "Вы начинаете искать обходной путь... и стена растягивается, становясь бесконечной. Вы понимаете: ваше стремление избежать прямого контакта — это главная преграда на вашем пути.",
            
            "Вы кричите тени, требуя ответов... и она растворяется. Вы остаетесь один на один с огнем, который теперь кажется еще более непроницаемым, чем раньше.",
            
            "Вы пытаетесь потушить огонь... и стена становится плотнее. Вы оказываетесь запертым в комнате с символом, пока не поймете: \"Огонь — не препятствие, а зеркало. Почему я боюсь увидеть свое отражение?\"",
            
            "Вы задаете огню вопрос... и он искажает его, превращая в бессмысленный шум. Вы понимаете, что некоторые вопросы нельзя задавать, пока не готовы услышать ответ."
        ],
        "correct_message": ("Вы проходите сквозь огонь. Он не обжигает — он <i>пропускает</i> вас, "
                           "как луч света через воду. По ту сторону стоит тень, которая говорит "
                           "ваше имя так, как его произносили до того, как вы его получили. "
                           "\"Ты прошел через огонь, но твой страх все еще с тобой. Отпусти его.\""),
        "next_stage_delay": 0
    },
    {
        "title": "Озеро Забвения",
        "description": ("Вы стоите у кромки черного озера. Вода не отражает небо — она отражает <i>ваше будущее</i>. "
                       "Каждое отражение — это вы, но вы не узнаете себя. Лица меняются, как кадры в фильме.\n\n"
                       "Тень говорит: \"Чтобы увидеть то, что ждет, ты должен забыть, кем ты был.\" "
                       "Вы чувствуете, как части вашего \"я\" начинают отслаиваться, как старая краска. "
                       "Вода холодная и живая. Погружаясь, вы чувствуете, как части вашего \"я\" отслаиваются."),
        "options": [
            "Попытаться собрать отражение",
            "Убежать от озера",
            "Войти в воду",
            "Спросить у тени совета",
            "Запомнить все отражения"
        ],
        "correct_option": 2,
        "wrong_messages": [
            "Вы пытаетесь собрать отражение в ладони... и озеро застывает, как стекло. Вы видите себя в будущем, но без лица. Вы застрянете в этом моменте, пока не поймете: \"Память — это стена. Почему я верю, что прошлое реально?\"",
            
            "Вы убегаете от озера... но оно следует за вами. Вы понимаете, что бежите не от озера, а от самого себя. Пока вы не остановитесь, путь не продолжится.",
            
            "Вы спрашиваете у тени совета... и она исчезает. Вы остаетесь один на один с озером, понимая, что внешние советы лишь отвлекают вас от внутреннего знания.",
            
            "Вы пытаетесь запомнить все отражения... и ваша голова наполняется хаотичными образами. Вы теряете связь с настоящим моментом, застряв между прошлым и будущим."
        ],
        "correct_message": ("Вода холодная и живая. Погружаясь, вы чувствуете, как части вашего \"я\" "
                           "отслаиваются, как старая краска. Когда вы выходите на другой берег, "
                           "вы не помните своего имени, но знаете: вы ближе к тому, что ждет."),
        "next_stage_delay": 0
    },
    {
        "title": "Лабиринт Без Правил",
        "description": ("Вы в лабиринте, где стены двигаются. Надписи на стенах меняются, когда вы отводите взгляд. "
                       "Вы понимаете: это не лабиринт пространства, а лабиринт вашего разума.\n\n"
                       "Каждый поворот — это выбор, который вы делали в прошлом. Каждая стена — убеждение, "
                       "которое вы считали истиной. Лабиринт не хочет, чтобы вы вышли. Он хочет, чтобы вы остались. "
                       "Вы чувствуете, как что-то наблюдает за вами из теней."),
        "options": [
            "Сесть и закрыть глаза",
            "Искать закономерность",
            "Выбирать путь наугад",
            "Кричать на лабиринт",
            "Спрашивать совета у стен"
        ],
        "correct_option": 0,
        "wrong_messages": [
            "Вы пытаетесь запомнить маршрут... и лабиринт становится бесконечным. Вы ходите по кругу, пока не поймете: \"Память — это стена. Почему я верю, что прошлое реально?\"",
            
            "Вы выбираете путь наугад... и лабиринт подстраивается под ваши решения. Вы понимаете, что случайность — это тоже паттерн, и ваш выбор не так случаен, как кажется.",
            
            "Вы кричите на лабиринт... и он отвечает эхом вашего собственного голоса. Вы застрянете здесь, пока не перестанете бороться и не начнете слушать то, что лабиринт пытается вам показать.",
            
            "Вы спрашиваете стену совета... и каждая стена дает противоречивый ответ. Вы понимаете, что ищете внешних указаний там, где нужно прислушаться к внутреннему голосу."
        ],
        "correct_message": ("Когда вы закрываете глаза, лабиринт исчезает. Вы стоите в пустоте, "
                           "где время не течет. Тень говорит: \"Ты начал видеть без глаз. "
                           "Теперь ты можешь услышать шепот того, что ждет.\""),
        "next_stage_delay": 0
    },
    {
        "title": "Шепот из Пустоты",
        "description": ("В пустоте вы слышите шепот. Он не в ушах, а <i>в костях</i>. Шепот говорит на языке, "
                       "которого нет, но вы понимаете каждое слово. Это не язык — это вибрация самой реальности.\n\n"
                       "Вы понимаете, что шепот был с вами всегда. Он шептал вам во снах, в тишине, "
                       "в шуме города. Вы просто не слышали его, потому что боялись. "
                       "Шепот не требует, он предлагает. Вы чувствуете, как ваше сознание расширяется."),
        "options": [
            "Повторять шепот",
            "Спрашивать, что означает шепот",
            "Позволить шепоту войти в тебя",
            "Пытаться записать шепот",
            "Игнорировать шепот"
        ],
        "correct_option": 2,
        "wrong_messages": [
            "Вы пытаетесь повторить шепот... и он затихает. Вы понимаете, что шепот нельзя воспроизвести — он существует только в моменте принятия, а не в попытках контролировать его.",
            
            "Вы спрашиваете, что означает шепот... и он исчезает. Вы остаетесь в тишине, задаваясь вопросом: \"Почему я требую, чтобы реальность подчинялась моему пониманию?\"",
            
            "Вы пытаетесь записать шепот... но никакие инструменты не могут его зафиксировать. Вы понимаете, что некоторые знания нельзя передать через слова или записи.",
            
            "Вы игнорируете шепот... и он становится громче, пока не заполняет все ваше сознание. Вы застрянете в этом состоянии, пока не научитесь слышать, не пытаясь понять."
        ],
        "correct_message": ("Вы перестаете слушать шепот — вы становитесь им. Вибрация проходит сквозь вас, "
                           "и вы понимаете: реальность — это не то, что вы видите, а то, как вы вибрируете. "
                           "Тень говорит: \"Теперь ты готов встретить то, что ждет. Но помни: оно не будет тем, "
                           "кого ты ищешь.\""),
        "next_stage_delay": 0
    },
    {
        "title": "Встреча, Которой Нет",
        "description": ("Перед вами — пустота. Но вы знаете, что что-то здесь. Оно не будет говорить. "
                       "Оно не будет показывать. Оно просто будет... присутствовать.\n\n"
                       "Вы чувствуете его присутствие как давление на кожу, как мурашки по спине, "
                       "как внезапное понимание, что вы никогда не были одиноки. Оно не человек, не существо — "
                       "присутствие <i>самой реальности</i>. Вы понимаете, что оно было с вами с самого начала."),
        "options": [
            "Спросить: \"Кто ты?\"",
            "Опуститься на колени",
            "Молчать",
            "Попытаться увидеть",
            "Задать условия встречи"
        ],
        "correct_option": 2,
        "wrong_messages": [
            "Вы спрашиваете: \"Кто ты?\"... и пустота становится стеной. Вы оказываетесь в лабиринте снова, пока не поймете: \"Оно — не объект для вопросов. Почему я верю, что все должно иметь имя?\"",
            
            "Вы опускаетесь на колени... и земля под вами исчезает. Вы падаете в пустоту, пока не поймете: поклонение создает дистанцию там, где должна быть связь.",
            
            "Вы пытаетесь увидеть... и ваши глаза наполняются светом, который ослепляет вас. Вы понимаете, что некоторые вещи нельзя увидеть взглядом, но можно почувствовать всем существом.",
            
            "Вы задаете условия встречи... и пустота остается пустой. Вы застрянете в ожидании, пока не поймете: встреча происходит, когда вы перестаете контролировать процесс."
        ],
        "correct_message": ("Вы молчите. И в этом молчании вы чувствуете присутствие. "
                           "Не человека, не существо — присутствие <i>самой реальности</i>. "
                           "Вы понимаете, что оно — это не тот, кого вы искали. Оно — это путь, который вы прошли."),
        "next_stage_delay": 0
    },
    {
        "title": "Падение в Себя",
        "description": ("Вы падаете. Не вниз, а... внутрь. Каждый момент падения — это целая жизнь. "
                       "Вы видите себя во всех ваших воплощениях, но они не ваши. Это маски, которые вы носили.\n\n"
                       "Вы понимаете: вы не падаете в себя — вы расширяетесь во все миры одновременно. "
                       "Каждое \"я\" — это лишь капля в океане вашего сознания. Вы чувствуете, "
                       "как границы растворяются, как время теряет смысл."),
        "options": [
            "Пытаться остановить падение",
            "Принять, что нет ни верха, ни низа",
            "Выбирать одно из воплощений",
            "Спросить, куда вы падаете",
            "Пытаться вспомнить свое имя"
        ],
        "correct_option": 1,
        "wrong_messages": [
            "Вы пытаетесь остановить падение... и застреваете между мирами. Вы проведете время в состоянии, где время не течет, размышляя: \"Почему я верю, что должен контролировать падение?\"",
            
            "Вы выбираете одно из воплощений... и остальные исчезают. Вы теряете связь с целостностью своего существа, застревая в ограниченном представлении о себе.",
            
            "Вы спрашиваете, куда падаете... и вопрос эхом возвращается к вам. Вы понимаете, что падение — это не движение в пространстве, а расширение сознания.",
            
            "Вы пытаетесь вспомнить свое имя... и оно рассыпается, как песок сквозь пальцы. Вы застрянете в поиске идентичности там, где она не нужна."
        ],
        "correct_message": ("Вы перестаете бороться с падением. И в этом принятии вы понимаете: "
                           "падение — это полет. Вы не падаете в себя — вы расширяетесь "
                           "во все миры одновременно."),
        "next_stage_delay": 0
    },
    {
        "title": "Последний Вопрос",
        "description": ("Вы стоите перед зеркалом. В нем нет отражения. Вместо этого — вопрос: \"Кто видит?\"\n\n"
                       "Вы понимаете, что вопрос не может быть задан. Он просто есть, как воздух, "
                       "как время, как сама реальность. Вы чувствуете, как что-то внутри вас улыбается. "
                       "Зеркало не отражает — оно знает. Оно не спрашивает — оно напоминает."),
        "options": [
            "Сказать свое имя",
            "Спросить: \"А кто спрашивает?\"",
            "Разбить зеркало",
            "Закрыть глаза",
            "Попытаться понять вопрос"
        ],
        "correct_option": 1,
        "wrong_messages": [
            "Вы говорите: \"Я\"... и зеркало исчезает. Вы остаетесь с пустотой, задаваясь вопросом: \"Если 'я' — это иллюзия, кто же видит эту иллюзию?\"",
            
            "Вы разбиваете зеркало... и осколки становятся новыми зеркалами, задающими тот же вопрос. Вы застрянете в бесконечном цикле, пока не поймете: ответ не в разрушении вопроса, а в понимании его природы.",
            
            "Вы закрываете глаза... и вопрос становится громче. Вы понимаете, что игнорирование вопроса не делает его менее реальным.",
            
            "Вы пытаетесь понять вопрос... и он становится еще более загадочным. Вы застрянете в интеллектуальных построениях, пока не осознаете: некоторые вопросы не для ответа, а для пробуждения."
        ],
        "correct_message": ("Зеркало улыбается. Вопрос меняется: \"Хорошо. Теперь ты готов.\" "
                           "Вы понимаете, что оно было с вами с самого начала — это ваше собственное осознание, "
                           "которое вы принимали за внешнего учителя."),
        "next_stage_delay": 0
    },
    {
        "title": "Возвращение, Которого Нет",
        "description": ("Вы стоите на той же пустынной улице, где начали. Полдень. Воздух дрожит. "
                       "Но теперь вы видите <i>все</i> трещины. Вы понимаете: мир не сломан. "
                       "Мир — это сеть трещин, через которые просвечивает истинная реальность.\n\n"
                       "Вы улыбаетесь и идете дальше. Трещины все еще здесь, но теперь они — "
                       "часть вашей реальности. Вы понимаете: оно не было целью. Оно — это путь, "
                       "который изменил вас. Мир вокруг не изменился. Изменилось то, как вы его видите."),
        "options": [
            "Пройти сквозь ближайшую трещину",
            "Попытаться рассказать людям",
            "Улыбнуться и пойти дальше",
            "Попытаться закрыть трещины",
            "Сфотографировать трещины"
        ],
        "correct_option": 2,
        "wrong_messages": [
            "Вы проходите сквозь трещину... и попадаете в зеркальный лабиринт, где каждая трещина ведет к новой трещине. Вы понимаете: путь не имеет конца, пока вы ищете цель.",
            
            "Вы пытаетесь рассказать людям... и они смотрят на вас с недоумением. Вы чувствуете, как ваше объяснение теряет смысл в воздухе. Вы проведете время в мире, где никто не видит трещин, размышляя: \"Почему я хочу, чтобы другие видели то, что вижу я?\"",
            
            "Вы пытаетесь закрыть трещины... и они становятся шире. Вы понимаете: трещины — это не повреждение, а признак жизни реальности. Вы застрянете в попытках исправить то, что не нужно исправлять.",
            
            "Вы фотографируете трещины... и на снимках видна только обычная улица. Вы понимаете: камера фиксирует лишь то, что видит глаз, а не то, что видит сердце. Вы проведете время в сомнениях, пока не поймете: \"Трещины видны только тем, кто готов их увидеть.\""
        ],
        "correct_message": ("Вы улыбаетесь и идете дальше. Трещины все еще здесь, но теперь они — "
                           "часть вашей реальности. Вы понимаете: оно не было целью. Оно — это путь, "
                           "который изменил вас. Мир вокруг не изменился. Изменилось то, как вы его видите."),
        "next_stage_delay": 0
    }
]

def get_journey_state(user_id: int, db_session) -> Dict:
    """Получает состояние пути пользователя из БД"""
    return {
        "current_stage": 0,
        "last_wrong_answer": None,
        "journey_started": True,
        "completed": False
    }

def can_continue_journey(user_data: Dict) -> bool:
    """Проверяет, может ли пользователь продолжить путь"""
    if not user_data.get('journey_started', False):
        return True
    if user_data.get('completed', False):
        return False
    last_wrong = user_data.get('last_wrong_answer')
    if last_wrong:
        try:
            last_wrong_dt = datetime.datetime.fromisoformat(last_wrong)
            return (datetime.datetime.now() - last_wrong_dt).total_seconds() >= 600  # 10 минут
        except (ValueError, TypeError):
            return False
    return True

def process_answer(user_id: int, stage: int, answer: int, db_session=None) -> Dict:
    """
    Обрабатывает ответ пользователя
    Returns:
        {
            "is_correct": bool,
            "message": str,
            "next_stage": Optional[int],
            "completed": bool,
            "can_continue": bool
        }
    """
    if stage >= len(STAGES):
        return {
            "is_correct": False,
            "message": "Неверный этап.",
            "next_stage": None,
            "completed": True,
            "can_continue": False
        }
    
    stage_data = STAGES[stage]
    
    if answer == stage_data["correct_option"]:
        # Правильный ответ
        next_stage = stage + 1
        completed = next_stage >= len(STAGES)
        return {
            "is_correct": True,
            "message": stage_data["correct_message"],
            "next_stage": next_stage if not completed else None,
            "completed": completed,
            "can_continue": not completed
        }
    else:
        # Неправильный ответ
        # Создаем список индексов неправильных ответов
        wrong_indices = [i for i in range(len(stage_data["options"])) if i != stage_data["correct_option"]]
        # Находим позицию выбранного ответа в списке неправильных ответов
        try:
            wrong_index = wrong_indices.index(answer)
            return {
                "is_correct": False,
                "message": stage_data["wrong_messages"][wrong_index],
                "next_stage": None,
                "completed": False,
                "can_continue": False
            }
        except ValueError:
            # Защита от ошибки, если ответ не найден в списке
            return {
                "is_correct": False,
                "message": "Произошла ошибка при обработке вашего ответа. Пожалуйста, начните путь заново.",
                "next_stage": None,
                "completed": False,
                "can_continue": False
            }